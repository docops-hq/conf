<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>FAQ по архитектуре и работе ВКонтакте &middot; Конспекты</title><link rel=stylesheet href=/conf/css/style.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700"><link rel=stylesheet href=/conf/custom.css><link rel=icon type=image/png sizes=32x32 href=/conf/images/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/conf/images/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/conf/images/apple-touch-icon.png><link href rel=alternate type=application/rss+xml title=Конспекты><script async src="https://www.googletagmanager.com/gtag/js?id=UA-107215405-3"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-107215405-3');</script></head><body><nav class=nav><div class=nav-container><a href=/conf/><h2 class=nav-title>Конспекты</h2></a><ul><li><a href=/conf/>Posts</a></li></ul></div></nav><main><div class=post><div class=single__header><div class=post-info>Алексей Акулович, ВКонтакте</div><h1 class=post-title>FAQ по архитектуре и работе ВКонтакте</h1><div class=post-line></div><div class=tag-block><span class=catalogue-tags><a href=/conf/tags/highload class=tags>Highload</a></span><span class=catalogue-tags><a href=/conf/tags/2018 class=tags>2018</a></span><span class=catalogue-tags><a href=/conf/tags/%D0%B2%D0%BA%D0%BE%D0%BD%D1%82%D0%B0%D0%BA%D1%82%D0%B5 class=tags>ВКонтакте</a></span></div></div><h1 id=архитектура>Архитектура</h1><ul><li>фронты: независимые сервера с nginx, анонсируют общие IP,терминируют HTTPS/WSS.</li><li>бэкенды: http сервера на kPHP, модель работы prefork, вместо перезапуска сбрасывают состояние (global/static vars).</li></ul><p>Для распределения нагрузки:</p><pre><code>* Бэкенды группируются: general, mobile, api и т.п. Выбирает между ними nginx на фронте.

* Сбор метрик и перебалансировка.
</code></pre><ul><li>Content server (cs). Хранят и обрабатывают файлы.</li><li><p>Часть cs закрыты специальными pu/pp серверами (photo upload / photo proxy). Зачем они нужны?</p><ul><li>для терминирования HTTPS</li><li>чтобы использовать серые IP-адреса для cs</li><li>для отказоустойчивости через общие IP</li><li>спорно — чтобы клиент держал меньше соединений</li></ul><p>Обычно видео гоняется напрямую, а более лёгкий контент — через прокси.</p></li><li><p>sun — новая альтернатива pp. Зачем:</p><ul><li>у pp один IP на группу, в результате один файл оседает во всех кешах</li><li>pp нельзя шардировать и ставить в регионах</li></ul></li></ul><p>Как устроены sun:</p><pre><code>* маршрутизация anycast
* кеширование
* поддержка весов
* можно ставить в регионах
* шардирование по id контента (например, когда 100000 человек запрашивают аватарку одного пользователя)
</code></pre><ul><li><p>cache — региональные кеши. Регион определяем так:</p><ol><li>сбор сетей региона по BGP</li><li>инфа загружается в базу, + geoip</li><li>по IP пользователя определяем регион</li></ol></li><li><p>engines — базы данных</p></li></ul><h1 id=базы-данных>Базы данных</h1><p>Называем engines, потому что это не совсем базы данных.</p><p>В 2008-2009 использовали MySQL и Memcached, но они не выдержали взрывного роста пользователей. Заменили их на велосипеды.</p><p>Типов движков очень много. На каждую задачу — новый тип движка. Очереди, списки, сеты — всё что угодно.</p><p>Движки одного типа объединяются в кластеры. Код не знает расположения и размера кластеров. Для этого между серверами и базами есть ещё rpc-proxy:</p><ul><li>общая шина</li><li>service discovery, forwarding</li><li>circuit breaker</li></ul><p>На каждом сервере есть локальный rpc-proxy, который знает, куда направить запросы и где находятся engines.</p><p>Если один engine идёт в другой, то тоже делает это через прокси. Engine не должен знать ничего, кроме себя.</p><p>Персистентное хранение данных:</p><ul><li>движки пишут бинлоги: binary log (WAL, AOF). Пишутся в одинаковом бинарном формате (TL scheme), чтобы админы их читали своими инструментами.</li><li>снапшоты: слепок данных + offset в бинлоге. Общее начало, тело произвольное.</li></ul><p>При перезапуске движок сначала читает снапшот, восстанавливает из него своё состояние. Потом из него находит offset, по нему дочитывает остаток из бинлога, восстанавливает окончательное состояние.</p><p>Результат: репликация данных:</p><ul><li>statement-based</li><li>инкрементальный унос «хвоста» бинлога</li></ul><p>Эта же схема используется для создания бэкапов.</p><p><img src=../../../images/vk-binlog.png alt=vk-binlog></p><h1 id=логи>Логи</h1><p>Как собираются?</p><ul><li>отправка в memcached. Там кольцевой буфер (<code>ring-buffer: prefix.idx = line</code>).</li><li>отправка в logs-engine (разработан in-house)</li></ul><p>Хранятся в ClickHouse. Чтобы это заработало, приходится локальный rpc-proxy заменить на KittenHouse, а на движке добавлять KittenHouse reverse proxy.</p><p>А ещё есть nginx, чтобы получать логи по UDP.</p><p><img src=../../../images/clickhouse-logs.png alt=clickhouse-logs></p><h1 id=мониторинг>Мониторинг</h1><p>Есть два типа метрик.</p><p>Системные и админские метрики:</p><ul><li>netdata собирает статистику,</li><li>отсылает в Graphite Carbon</li><li>ClickHouse</li><li>можно смотреть через Grafana</li></ul><p>Продуктовые и разработческие метрики:</p><ul><li>много метрик</li><li>очень много событий — от 0,6 до 1 триллиона в сутки</li><li>храним 2+ года</li></ul><p>Эксперимент: собираем метрики на ClickHouse</p><ul><li>удобнее основной системы</li><li>требует меньше серверов, но сами сервера жирнее</li></ul><h1 id=деплой>Деплой</h1><p>Git, GitLab, TeamCity</p><p>PHP:</p><ol><li>git pruduction branch</li><li>diff файла</li><li>записывается в binlog copyfast</li><li>реплицируется на сервера через gossip replication</li><li>применяется локальными репликами на локальной файловой системе</li></ol><p>kPHP:</p><ul><li>большой бинарь, сотни МБ</li><li>git master branch</li><li>версию пишем в binlog copyfast</li><li>реплицируем версию на сервера</li><li>сервер вытягивает свежий бинарник через gossip replication</li><li>graceful-перезапуск на новую версию</li></ul><p>Движки:</p><ul><li>бинари в .deb</li><li>git master branch</li><li>версию пишем в binlog copyfast</li><li>реплицируем версию на сервера</li><li>сервер вытягивает свежий .deb</li><li>dpkg -i</li><li>graceful-перезапуск на новую версию</li></ul><h1 id=другие-доклады-про-архитектуру-vk>Другие доклады про архитектуру VK</h1><ul><li><a href=https://highload.ru/2016/abstracts/2416>Системный администратор ВКонтакте. Как?</a></li><li><a href=https://2018.codefest.ru/lecture/1250>Разработка в ненадёжной нагруженной среде</a></li><li>Как VK вставляет данные в ClickHouse с десятков тысяч серверов: на <a href=https://highload.ru/siberia/2018/abstracts/3614>Highload Siberia</a> и на <a href=https://highload.ru/moscow/2018/abstracts/4066>Highload Moscow</a></li><li><a href=https://highload.ru/2016/abstracts/2414>Архитектура растущего проекта на примере ВКонтакте</a></li></ul></div><div class=pagination><a href=/conf/moscowpython/19/go-vs-python/ class="left arrow">&#8592;</a>
<a href=/conf/qualityconf/19/blameless/ class="right arrow">&#8594;</a>
<a href=# class=top>Top</a></div></main><footer><span>&copy; <time datetime="2020-07-13 11:44:29.092784154 &#43;0000 UTC m=&#43;0.108318370">2020</time> . Made with <a href=https://gohugo.io>Hugo</a> using the <a href=https://github.com/EmielH/tale-hugo/>Tale</a> theme.</span></footer></body></html>