<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Монолит для сотен версий клиентов: как мы пишем и поддерживаем тесты &middot; Конспекты</title><link rel=stylesheet href=/conf/css/style.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700"><link rel=stylesheet href=/conf/custom.css><link rel=icon type=image/png sizes=32x32 href=/conf/images/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/conf/images/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/conf/images/apple-touch-icon.png><link href rel=alternate type=application/rss+xml title=Конспекты><script async src="https://www.googletagmanager.com/gtag/js?id=UA-107215405-3"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-107215405-3');</script></head><body><nav class=nav><div class=nav-container><a href=/conf/><h2 class=nav-title>Конспекты</h2></a><ul><li><a href=/conf/>Posts</a></li></ul></div></nav><main><div class=post><div class=single__header><div class=post-info>Владимир Янц, Badoo</div><h1 class=post-title>Монолит для сотен версий клиентов: как мы пишем и поддерживаем тесты</h1><div class=post-line></div><div class=tag-block><span class=catalogue-tags><a href=/conf/tags/highload class=tags>Highload</a></span><span class=catalogue-tags><a href=/conf/tags/2018 class=tags>2018</a></span><span class=catalogue-tags><a href=/conf/tags/badoo class=tags>Badoo</a></span></div></div><p>Темы:</p><ol><li>Наш процесс разработки</li><li>Юнит-тесты</li><li>Интеграционные тесты</li><li>Тесты на API</li><li>Прогон тестов</li></ol><h1 id=процесс-разработки>Процесс разработки</h1><p>К сроку выкатывания фичи добавляется:</p><ul><li>desktop web + два месяца</li><li>mobile web + неделя</li><li>iOS + месяц</li><li>android + полгода</li></ul><p>Разработчик отвечает за фичу от бэкенда до реализации на платформах. Интеграция бывает нескоро. Поэтому хочется сделать так, чтобы интеграция прошла хорошо.</p><p>Нужны автотесты!</p><h1 id=unit-tests>Unit-tests</h1><p>Тесты на изолированные кусочки кода.</p><p>Сложно тестировать легаси. Для него делаем SoftMocks. Оно перехватывает все include/require в PHP-файле, подменяет подключаемый файл на другой.</p><p>Можно мокать любые методы: статические, приватные, финальные.</p><p>Проблема: SoftMocks расслабляют — можно писать плохо тестируемый код и всё равно покрыть его тестами. Решили правилами:</p><ul><li>новый код должен быть легко тестируемым с помощью PHPUnit</li><li>SoftMocks — крайний случай, когда иначе нельзя.</li></ul><p>Правила проверяются на код-ревью.</p><p>Мутационное тестирование.</p><ol><li>берем код</li><li>берем code coverage</li><li>парсим код и генерируем мутации: меняем плюс на минус, true на false</li><li><p>для каждой мутации прогоняем набор тестов:</p><ul><li>если тесты упали — они хорошие</li><li>если тесты успешно прошли — они недостаточно эффективны</li></ul></li></ol><p>Для PHP есть готовые решения: Humbug, Infection. Но они несовместимы с SoftMocks. Поэтому написали своё.</p><h1 id=интеграционные-тесты>Интеграционные тесты</h1><p>Тестируем работу нескольких компонентов в связке.</p><p>Стандартный подход:</p><ol><li>Поднимаем тестовую БД</li><li>Заполняем её</li><li>Запускаем тест</li><li>Очищаем БД</li></ol><p>Есть проблемы:</p><ul><li>нужно поддерживать актуальность содержимого базы</li><li>требуется время на подготовку</li><li>параллельные запуски делают тесты нестабильными и порождают дедлоки (когда тесты работают с одной и той же таблицей)</li></ul><p>Решение: DBMocks</p><ol><li>Методы драйверов DB перехыватываются с помощью SoftMOcks на setUp теста</li><li>из запроса вытаскиваются db + table</li><li>создаются временные таблицы с такой же схемой</li><li>все запросы идут во временные таблицы</li><li>потом на tearDown они удаляются</li></ol><p>Результаты:</p><ul><li>тесты не могут повредить данные в оригинальных таблицах</li><li>тестируем совместимость запроса с версией MySQL.</li><li>тесты вообще ходят в ту же БД по тому же адресу (просто таблица другая)</li><li>тесты изолированы друг от друга</li></ul><h1 id=api-тесты>API-тесты</h1><ul><li>имитируют клиентскую сессию</li><li>умеют слать запросы к бэкенду</li><li>бэкенд отвечает почти как реальному клиенту</li></ul><p>Обычно такие тесты требуют авторизованного пользователя. Его нужно создать перед тестом и удалить после. Это порождает риск нестабильности, потому что при создании пользователя есть репликация и фоновые задачи.</p><p>Решение: пул тестовых пользователей.</p><ol><li>Нужен пользователь</li><li>ищем в пуле</li><li>если нет — создаём</li><li>после теста очищаем, потому что тест загрязняет пользователя</li></ol><p>Тестовые пользователи в одном окружении с реальными? Зачем вообще их тестировать на бою? Потому что devel ≠ prod. Надо изолировать, иначе пользователи будут флиртовать с кучей фиктивных Олегов.</p><p>Путь 1: флаг <code>is_test_user</code>, по флагу изолируем внутри сервисов.</p><p>Путь 2: всех пользователей переселяем в условную Антарктиду и они там тусят друг с другом.</p><h2 id=qa-api>QA API</h2><p>бэкдор для тестирования</p><ul><li>хорошо документированные методы API</li><li>быстро и легко управляют данными</li><li>пишут их бэкенд-разработчики</li><li>применимы только к тестовым пользователям</li></ul><p>Позволяют сменить пользователю неизменяемые данные, вроде даты регистрации.</p><p>Безопасность</p><ul><li>сетевая изоляция — доступно только из офисной сети</li><li>с каждым запросом передаётся secret, валидность которого проверяем</li><li>методы не работают с реальными пользователями</li><li>программа BugsBounty на hackerone</li></ul><h1 id=прогон-тестов>Прогон тестов</h1><ul><li>100 000 юнит, 40 минут</li><li>6 000 интеграционных, 90 минут</li><li>14 000 API, 600 минут</li></ul><p>Распараллелили тесты в TestCloud.</p><p>Как распределить тесты между потоками?</p><ul><li>поровну — фигня, все тесты разные, получатся неравные по времени части</li><li>запустить несколько потоков и скармливать тесты по одному — тратим время на инициализацию PHP-окружения. Долго!</li></ul><p>Как сделали:</p><ul><li>собираем статистику по времени прогона</li><li>компонуем тесты так, чтобы один chunk прогонялся не более чем за 30 секунд</li></ul><p>Проблема: медленные тесты занимают ресурсы, не давая выполняться быстрым. Т.е. API могут занять весь Cloud.</p><p>Решение: разделили Cloud</p><ul><li>часть 1 прогоняет только быстрые тесты</li><li>часть 2 прогоняет любые тесты</li></ul><p>Результат:</p><ul><li>Unit — 1 минута</li><li>Интеграционные — 5 минут</li><li>API — 15 минут</li></ul><p>Какие тесты выполнять? Покажет code coverage.</p><ol><li>Получаем branch diff</li><li>формируем список измененных файлов</li><li>получаем список тестов, которые его покрывают</li><li>запускаем прогон набора только из этих тестов</li></ol><p>А где взять coverage?</p><ul><li>раз в сутки, ночь, полный прогон с test coverage</li><li>результаты складываем в БД</li></ul><p>Плюсы:</p><ul><li>прогоняем меньше тестов: меньше нагрузка на железо и быстрее обратная связь</li><li>можем запускать тесты для патчей. Это позволяет быстро выкатить хотфикс. В патчах скорость важнее всего.</li></ul><p>Минусы:</p><ul><li>Релизим бэкенд дважды в день, так что coverage актуален только для первого. Поэтому для билда прогоняем полный набор тестов.</li><li>API-тесты генерируют слишком большой coverage. Для них этот подход не даёт большой экономии.</li></ul><h1 id=итоги>Итоги</h1><ul><li>все уровни пирамиды тестирования нужны и важны</li><li>количество тестов ≠ качество. Делайте ревью кода тестов и мутационное тестирование.</li><li>изолируйте тестовых пользователей от реальных.</li><li>бэкдоры в бэкенде упрощают и ускоряют разработку тестов.</li><li>собирайте статистику по тестам.</li></ul><h1 id=ссылки>Ссылки</h1><ul><li>Слайды: bit.ly/yants-HL18</li><li>Наш протокол: <a href=https://youtu.be/G-AiDkZLOIs>«Как мы поддерживаем 100 разных
версий клиентов в Badoo» / Ярослав Голуб</a></li><li>SoftMocks: <a href=https://habr.com/company/badoo/blog/279617/>«SoftMocks: наша замена runkit для PHP 7»
/ Юрий Насретдинов</a>, <a href=https://github.com/badoo/soft-mocks>github.com/badoo/soft-mocks</a></li><li><a href=https://hackerone.com/badoo>Badoo BugsBounty</a></li><li>UI тесты: <a href=https://youtu.be/N0hYSHmRJTQ>«Cross Platform Mobile Test Automation and
Continuous Delivery» / Sathish Gogineni</a></li><li>TestCloud: <a href=https://tech.badoo.com/ru/article/115/parallelizatsija-unit-testov-badoo/>«Оптимальная параллелизация юнит-
тестов или 17000 тестов за 4 минуты» / Илья Кудинов</a></li></ul></div><div class=pagination><a href=/conf/knowledgeconf/19/voluntary-forced-knowledge-sharing/ class="left arrow">&#8592;</a>
<a href=/conf/knowledgeconf/19/xi-notes-for-developer/ class="right arrow">&#8594;</a>
<a href=# class=top>Top</a></div></main><footer><span>&copy; <time datetime="2020-07-13 11:49:03.506407239 &#43;0000 UTC m=&#43;0.143303510">2020</time> . Made with <a href=https://gohugo.io>Hugo</a> using the <a href=https://github.com/EmielH/tale-hugo/>Tale</a> theme.</span></footer></body></html>