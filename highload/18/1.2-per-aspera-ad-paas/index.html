<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Тернии контейнеризированных приложений и микросервисов &middot; Конспекты</title><link rel=stylesheet href=/conf/css/style.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700"><link rel=stylesheet href=/conf/custom.css><link rel=icon type=image/png sizes=32x32 href=/conf/images/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/conf/images/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/conf/images/apple-touch-icon.png><link href rel=alternate type=application/rss+xml title=Конспекты><script async src="https://www.googletagmanager.com/gtag/js?id=UA-107215405-3"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-107215405-3');</script></head><body><nav class=nav><div class=nav-container><a href=/conf/><h2 class=nav-title>Конспекты</h2></a><ul><li><a href=/conf/>Posts</a></li></ul></div></nav><main><div class=post><div class=single__header><div class=post-info>Иван Круглов, Booking.com</div><h1 class=post-title>Тернии контейнеризированных приложений и микросервисов</h1><div class=post-line></div><div class=tag-block><span class=catalogue-tags><a href=/conf/tags/highload class=tags>Highload</a></span><span class=catalogue-tags><a href=/conf/tags/2018 class=tags>2018</a></span></div></div><h1 id=проблема>Проблема</h1><p>Бизнес хочет ускорить time to market.</p><p>Есть роли серверов — server role. Новый продукт — новая роль. Надо писать puppet, открывать доступы и порты, конфигурировать-конфигурировать-конфигурироовать. ВРУЧНУЮ.</p><p>Это умеет горстка людей — это узкое звено. Они делают это дни или недели, это тоже.</p><p>Хотим: доступно всем, работает за минуты. Для решения стали строить PaaS.</p><h1 id=первые-попытки-решения>Первые попытки решения</h1><p>Пробовали:</p><ul><li>marathon</li><li>openshift</li><li>k8s</li></ul><p>Первые две платформы профакапили, последнюю наполовину. О том и речь в докладе.</p><h2 id=marathon>Marathon</h2><p>Начался как хакатон, но так и не закончился. Не хватило фич.</p><p>Мысль 1: не стоит недооценивать способность кода выживать.</p><h2 id=openshift>Openshift</h2><p>Случилась эйфория:</p><ul><li>Там же k8s, а его разработал Google</li><li>Там же есть Ansible, а это круто.</li><li>И ещё Open vSwitch, который должен был порешать все проблемы.</li></ul><p>Раз фичи есть, хотелось их использовать, просто потому что они клёвые. А потом эйфория закончилась. Началось непонятное поведение системы.</p><p>А ещё не было нормального мониторинга, алертов и лимитов. Разработчик опечатался и заиспользовал 100500 ресурсов платформы.</p><p>Мысль 2: Cool vs. boring. Три крупных сложных системы вместе — круто, но нереально. Лучше скучно, но работает, чем интересно, но не работает.</p><h3 id=проблема-с-деплоем>Проблема с деплоем</h3><p>От платформы хотели простой и удобный интерфейс. Как Heroku.</p><p>В результате: пользователей научили нажимать кнопку, а внутренности скрыли. При проблемах нужно идти и дебажить людям их приложения. Нет времени на развитие платформы.</p><p>Мысль 3: стоит сформулировать ожидание пользователей от системы и системы от пользователей.</p><p>Пользователям нужны хотя бы базовые знания о том, как платформа устроена внутри.</p><h3 id=проблема-с-интеграциями>Проблема с интеграциями</h3><p>Новые приложения должны работать со старой системой.</p><p>Точки интеграции:</p><ul><li>DLB (distributed load balancing)</li><li>service discovery</li><li>events</li><li>storage</li><li>DB: MySQL, Cassandra, Redis, Kafka</li><li>SSL certivicates, identity key management</li><li>Secrets</li></ul><p>Секреты в k8s:</p><ul><li>Не шифруются в etcd (появилось в 1.7 alpha)</li><li>Есть Vault, который пришлось форкнуть и дописывать. Сложный, но безопасный workflow.</li></ul><p>Мысль 4: k8s — клёво, но его интеграция в существующую экосистему компании важнее.</p><h2 id=результат-двух-первых-попыток-внедрения>Результат двух первых попыток внедрения</h2><ul><li>Устали</li><li>Задолбались</li><li>Потеряли доверие пользователей</li><li>Но был план!</li></ul><h2 id=план>План!</h2><ul><li>Минимум клёвых штук. Отказ от Ansible и Open vSwitch.</li><li>Мониторинг инфраструктуры. Сами сообщаем, что у нас проблемы.</li><li>Выстроили чёткие ожидания внутри команды, между командой и пользователями:</li></ul><blockquote><p>Если вы хотите использовать платформу, вы должны 1) иметь базовые знания о k8s, 2) обеспечить свой сервис поддержкой.</p></blockquote><p>и ещё ожидания с провайдерами интеграций.
* Инвестиции в знания.</p><pre><code>* тренинги
* онлайн-курсы
* книги
* документация
</code></pre><p>С этими идеями пришли к третьему шагу: внедрять чистый k8s.</p><h1 id=kubernetes>kubernetes</h1><p>(Пока что) не профакапленная платформа.</p><p>Сделали несколько кластеров — застраховались сами от себя. Если положат один, то только один, а не всю систему.</p><p>Архитектура:</p><p><img src=../../../images/booking-k8s-arch.png alt=booking-k8s-arch></p><h2 id=directly-routable-pods>Directly Routable Pods</h2><p>Цель — плоская и простая сеть. Каждой ноде назначен /27, маленькая подсеть. Каждый под получает адрес, как любой физический сервер — <code>10.*</code>. Между подами и другими хостами во внутренней сети — прямой доступ. Поэтому не нужен ingress.</p><p>Поощряем использование Pod IP-адреса. Экспортируем в Service Discovery и почти в DLB.</p><pre><code>service.namespace.svc.cluster.local

service.namespace.svc.eu-nl-prod-a.booking.com
</code></pre><h2 id=тестирование>Тестирование</h2><p>kube-probe — функциональное тестирование для k8s. Проверяет способность кластера выполнять:</p><ul><li>базовые функции</li><li>сетевое соединение</li><li>интеграции</li></ul><h1 id=результаты-и-достижения>Результаты и достижения</h1><ul><li>Есть стабильная система</li><li>~200 уникальных сервисов, количество растёт</li><li>Понимаем происходящее</li><li>Отладили взаимодействие</li><li>Вся система самообслуживается</li><li>Выстроили отлаженную систему обучения</li></ul><h1 id=заключение>Заключение:</h1><ul><li>Управление ожиданиями — ключ к успеху.</li><li>k8s хорош, но интеграция важнее.</li><li>k8s — это экосистема, он требует понимания даже со стороны пользователей.</li><li>важно вкладываться в обучение.</li></ul></div><div class=pagination><a href=/conf/highload/18/1.7-postgresql-errors/ class="left arrow">&#8592;</a>
<a href=/conf/knowledgeconf/19/biocad-knowledge-base-development/ class="right arrow">&#8594;</a>
<a href=# class=top>Top</a></div></main><footer><span>&copy; <time datetime="2021-09-16 15:13:53.000716145 &#43;0000 UTC m=&#43;0.150363390">2021</time> . Made with <a href=https://gohugo.io>Hugo</a> using the <a href=https://github.com/EmielH/tale-hugo/>Tale</a> theme.</span></footer></body></html>