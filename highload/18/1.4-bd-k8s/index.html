<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Базы данных и Kubernetes &middot; Конспекты</title><link rel=stylesheet href=/conf/css/style.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700"><link rel=stylesheet href=/conf/custom.css><link rel=icon type=image/png sizes=32x32 href=/conf/images/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/conf/images/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/conf/images/apple-touch-icon.png><link href rel=alternate type=application/rss+xml title=Конспекты><script async src="https://www.googletagmanager.com/gtag/js?id=UA-107215405-3"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-107215405-3');</script></head><body><nav class=nav><div class=nav-container><a href=/conf/><h2 class=nav-title>Конспекты</h2></a><ul><li><a href=/conf/>Posts</a></li></ul></div></nav><main><div class=post><div class=single__header><div class=post-info>Дмитрий Столяров, Флант</div><h1 class=post-title>Базы данных и Kubernetes</h1><div class=post-line></div><div class=tag-block><span class=catalogue-tags><a href=/conf/tags/highload class=tags>Highload</a></span><span class=catalogue-tags><a href=/conf/tags/2018 class=tags>2018</a></span></div></div><p>Вопрос:</p><ul><li>А можно ли базу в k8s?</li><li>А можно ли вообще stateful в k8s?</li></ul><p>А зачем нам вообще это? Потому что k8s — это <strike>клёво</strike>, удобно.</p><p>Что именно stateful?</p><ul><li>relational database</li><li>nosql database</li><li>in-memory database</li><li>message queue</li><li>search engine</li><li>object storage</li><li>configuration &amp; service discovery</li></ul><p>Тема доклада:</p><ol><li>Философия высокой доступности в k8s</li><li>Гарантии согласованности в k8s</li><li>Хранение данных и k8s</li></ol><h1 id=философия-высокой-доступности-в-k8s>Философия высокой доступности в k8s</h1><p>Питомцы или стадо? (Pets vs. cattle)</p><p>Раньше: два сервера-питомца. Мы их со всех сторон охраняем, чтобы не упали.</p><p>Теперь: загончик из pod&rsquo;ов и стадо контейнеров. Сдох — заменим.</p><p>Механизмы HA^</p><ul><li>Deployment, StatefulSet</li><li>PodAntiAffinity</li><li>PodDisruptionBudget — сколько максимум подов можно погасить.</li></ul><h1 id=гарантии-согласованности-в-k8s>Гарантии согласованности в k8s</h1><p>At-most-once guarantee. Запрос обрабатывает не более чем один узел.</p><p>Предположим, у нас нарушение связности.</p><p>Как раньше: узел отвалился, снаружи неясно, совсем он умер иил просто недоступен. Применяем fencing — пытаемся выключить/убить сервис. Когда удостоверились, только тогда другой узел может стать мастером и принимать соединения от клиентов. Тогда клиенту точно не ответят два.</p><p>В кубе есть два контроллера: Deployment и StatefulSet. В первом он сразу пересоздаёт контейнер. Во втором ждёт точных результатов. Но всё ещё нужен fencing. Его из коробки нет, но сделать можно.</p><h2 id=consistent-switchover>Consistent Switchover</h2><p>Как обойтись без fencing? Пусть у нас есть хитрый load balancer. Он может атомарно выключить весь трафик на один узел. Если узел упал, мы говорим LB выключить трафик на тот узел, дожидаемся реплики базы, включаем трафик на себя. Простой есть, но гораздо меньше. Называется «Consistent Switchover».</p><p>А где это в k8s? Расскажут позже.</p><h1 id=хранение-данных-и-k8s>Хранение данных и k8s</h1><p>k8s монтирует сетевой диск на ноду и так передаёт её контейнеру. Если контейнер выключается, диск перемонтируется и передаётся.</p><p>Сразу проблема: у диска есть латенси. Чем больше латенси, тем больше нужно потоков, чтобы выдержать заданный IOPS (input-output operations per second).</p><p><img src=../../../images/iops-hell.png alt=666></p><p>Итог</p><ul><li>C ReadWriteOnce всё отлично.</li><li>Старайтесь избегать Network File System.</li></ul><h1 id=кейсы>Кейсы</h1><h2 id=кейс-1-standalone>Кейс 1: Standalone</h2><p>Есть множество случаев, когда HA не нужна.</p><ul><li>Тестовые и стейджинги</li><li>Бывают некритичные микросервисы: 15 минут полежит и встанет, и нормально.</li></ul><p>Как на виртуалке, но мы же любим когда всё в k8s.</p><h2 id=кейс-2-реплицированная-пара-с-ручным-переключением>Кейс 2: Реплицированная пара с ручным переключением</h2><p>Два инстанса. Вручную включаем и выключаем трафик, когда нам это нужно. Эквивалент двух виртуалок с ручным переключением.</p><h2 id=кейс-3-масштабирование-нагрузки-на-чтение>Кейс 3. Масштабирование нагрузки на чтение</h2><p>Да, это не совсем про стейтфул. Но можно. Когда нагрузка выросла — добавили инстансов, ушла — убрали.</p><h2 id=кейс-4-умный-клиент>Кейс 4. Умный клиент</h2><p>Вместо балансирования запросов, выдаём всем узлам разные домены. Некоторые клиенты сами умеют в шардинг-репликацию.</p><h2 id=кейс-5-cloud-native-решения>Кейс 5. Cloud native решения</h2><p>Сами умеют:</p><ul><li>failover</li><li>recovery</li><li>consistency</li></ul><p>Ставятся в StatefulSet и всё сами умеют.</p><p>Как узнают друг о друге?</p><ul><li>K8s API</li><li>DNS (несколько А-записей)</li><li>Статически</li><li>Seed-узлы, которые друг друга сами помнят уже</li><li>Сторонний service discovery</li></ul><p>Как подключается клиент? Есть поддержка из коробки.</p><p>Горизонтальное масштабирование? Может быть или не быть, зависит от продукта.</p><p>Суть: все cloud native решения хорошо работают с k8s, потому что их делали сразу в расчёте на режим cattle.</p><h2 id=кейс-6-stolon-postgresql>Кейс 6. Stolon PostgreSQL</h2><p>PostgreSQL cloud native high availability.</p><p>Stolon помогает перейти от питомцев к стаду.</p><ul><li>keeper автоматически конфигурирует инстансы</li><li>sentinel следит за конфигурацией кластера и решает, кто будет мастером или стендбаем</li><li>proxy реализует consistent switchover</li></ul><h1 id=выводы>Выводы</h1><p>Технологии развиваются волнами. Сначала технология появляется, потом она становится простой. Пока что стейтфул в k8s — уже можно, но ещё сложно, но со временем станет проще и лучше.</p><p>Компания Flant делает инструмент <a href=https://github.com/flant/dapp>https://github.com/flant/dapp</a>.</p></div><div class=pagination><a href=/conf/frontendconf/19/style_silver_bullet/ class="left arrow">&#8592;</a>
<a href=/conf/highload/18/1.8-badoo-infradev/ class="right arrow">&#8594;</a>
<a href=# class=top>Top</a></div></main><footer><span>&copy; <time datetime="2020-12-08 06:39:34.424345095 &#43;0000 UTC m=&#43;0.110880213">2020</time> . Made with <a href=https://gohugo.io>Hugo</a> using the <a href=https://github.com/EmielH/tale-hugo/>Tale</a> theme.</span></footer></body></html>