<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Как устроить хайлоад на ровном месте &middot; Конспекты</title><link rel=stylesheet href=/conf/css/style.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700"><link rel=stylesheet href=/conf/custom.css><link rel=icon type=image/png sizes=32x32 href=/conf/images/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/conf/images/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/conf/images/apple-touch-icon.png><link href rel=alternate type=application/rss+xml title=Конспекты><script async src="https://www.googletagmanager.com/gtag/js?id=UA-107215405-3"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-107215405-3');</script></head><body><nav class=nav><div class=nav-container><a href=/conf/><h2 class=nav-title>Конспекты</h2></a><ul><li><a href=/conf/>Posts</a></li></ul></div></nav><main><div class=post><div class=single__header><div class=post-info>Олег Бартунов, Федор Сигаев, Postgres Professional</div><h1 class=post-title>Как устроить хайлоад на ровном месте</h1><div class=post-line></div><div class=tag-block><span class=catalogue-tags><a href=/conf/tags/highload class=tags>Highload</a></span><span class=catalogue-tags><a href=/conf/tags/2018 class=tags>2018</a></span></div></div><h1 id=что-такое-хайлоад>Что такое хайлоад</h1><p>Что такое хайлоад на самом деле?</p><p><em>Производительные</em> и <em>масштабируемые</em> системы <em>высокой доступности</em>.</p><p>Highload — чисто русское слово. Остальные используют high-volume.</p><p>Хайлоад — это ситуация в системе, грозящая отказом в обслуживании из-за недостатка ресурсов. Внештатная ситуация.</p><p>В идеале хайлоада не должно быть, но есть человеческие ошибки, которые ведут к недостатку ресурсов (железа, людей, денег), а он приводит к угрозе отказа в обслуживании.</p><p>Спешная починка костылями.</p><p>Костыль — решение задачи без серьёзного редизайна системы. Документированный костыль — полноценная фича системы.</p><p>Про что доклад:</p><ul><li>действия, которые создают хайлоад на ровном месте</li><li>известные, но важные ошибки</li><li>в частности про PostgreSQL</li></ul><p>Ошибки проектирования</p><ul><li>Неэффективное использование ресурсов, блокирование спящим процессом. Процесс ждёт, пока клиент заберёт свой запрос.</li><li>База наружу — внешний трафик внутри сети.</li><li>Разные сервисы на одной машине дерутся за ресурсы.</li><li>Останов мастера при исчезновении единственной синхронной реплики. Используйте одну синхронную и одну асинхронную реплику.</li><li>Неправильное или недостаточное тестирование</li><li>Пиковые нагрузки — по времени, по событиям, таймзонам.</li><li>Разумный отлуп роботов</li></ul><h1 id=ошибки-проектирования-бд>Ошибки проектирования БД</h1><ul><li>Пагинация. На страницу N+1 попадают 3% посетителей, и это скорее всего роботы. Не надо заранее выгружать вторую страницу с LIMIT/OFFSET. А если пользователь все-таки перешел на вторую, то далее выгружайте больше страниц сразу в кэш.</li><li>Узкие таблицы — оверхед постгресовых заголовков. Заголовок в постгресе всё равно займет не меньше чем 32 байта, даже если колонки — два bool.</li></ul><p>Пример: id-координата, 60 терабайт. Объединили 200 точек в 1 JSON, получилось 10 терабайт.
* Широкие таблицы — тоже плохо.
* NoSQL когда не надо. На больших данных джойны в клиенте приводят к аду.
* JSON/XML когда не надо.
* «Ненужная» точность вычислений
* Виртуализация и докер</p><h1 id=graceful-degradation>Graceful degradation</h1><ul><li>Мало кто думает</li><li>ПОС по нагрузке</li><li>Лучше обслужить кого-то, чем попытаться обслужить всех и упасть.</li><li>Поисковые системы лучше всего ищут в ночь с субботы на воскресенье. Когда нагрузки больше, они ограничивают задачу, чуть ухудшают качество, но зато не деградируют.</li></ul><h1 id=нелепости>Нелепости</h1><ul><li>Забытая клавиатура на стойке блокирует отвод тепла, процы понижают частоту.</li><li>Скомпилировали с дебагом (<code>--enable-cassert</code>).</li><li>Не материализация настроек — настроили, но не сохранили нигде</li><li>Логирование (prepared statements &amp; syslog).</li><li>foreign keys / triggers</li><li>бесконечные with recursive</li><li>зависшие транзакции — вакуум встаёт намертво</li><li>freeze и вообще автовакуум</li><li>неумеренное использование временных таблиц (bloat системного каталога)</li><li>ненужные и бесполезные индексы</li><li>много памяти без huge pages</li><li>ненужное шифрование</li><li>множественные savepoint (SubtransControlLock)</li><li>планируемые дедлоки</li><li>отключение генетического оптимизатора (geqo)</li></ul><p>Сложность оптимизации — факториал от количества таблиц индексов. Генетический оптимизатор избавляет от этой зависимости.</p><p>В PostgreSQL есть таймауты! Используйте их!</p><ul><li><code>authentification_timeout</code></li><li><code>wal_sender_timeout</code></li><li><code>statement_timeout</code></li><li><code>lock_timeout</code></li><li><code>idle_in_transaction_session_timeout</code></li><li><code>deadlock_timeout</code></li><li>TCP keepalive (оба два!)</li></ul><p>И еще много других!</p><p>Камни, под которые редко заглядывают:</p><ul><li><code>Max_files_per_process</code></li><li><code>bgwriter_*</code></li><li><code>Effective_io_concurrency</code></li><li><code>Effective_cache_size</code></li><li>Параллелизм помогает только когда есть свободные ядра.</li><li><code>Wal_level</code></li><li><code>Random_page_cost</code></li><li><code>*_collapse_limit</code> если скорость работы зависит от порядка джойнов — упёрлись в этот лимит.</li><li><code>default_transaction_read_only</code></li><li><code>max_connection</code> (и на реплике!)</li><li>временные файлы постгреса — следить, чтобы постгрес создавал их меньше</li><li>отстающие реплики (гроханье таблиц по одной для освобождения диска)</li></ul><h1 id=срочные-костыли-не-делайте-так>Срочные костыли (не делайте так)</h1><ul><li>fsync = off (data_loss = on)</li><li>synchronous commit = on (лог и миримся с потерями)</li><li>unlogged table (кстати, и hash index тоже (до PG10))</li></ul><h1 id=хайлоада-не-избежать>Хайлоада не избежать!</h1><ul><li>Всегда нужен план Б:<ul><li>жертвуем доступностью, чтобы избежать эффекта домино</li><li>сохраняем целостность данных</li></ul></li><li>Обязательны полевые учения.</li></ul></div><div class=pagination><a href=/conf/knowledgeconf/19/xi-notes-for-developer/ class="left arrow">&#8592;</a>
<a href=/conf/highload/18/2.4-dababase-pro/ class="right arrow">&#8594;</a>
<a href=# class=top>Top</a></div></main><footer><span>&copy; <time datetime="2021-09-16 15:13:52.984808719 &#43;0000 UTC m=&#43;0.134455964">2021</time> . Made with <a href=https://gohugo.io>Hugo</a> using the <a href=https://github.com/EmielH/tale-hugo/>Tale</a> theme.</span></footer></body></html>