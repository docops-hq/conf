<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Что мы знаем о микросервисах &middot; Конспекты</title><link rel=stylesheet href=/conf/css/style.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700"><link rel=stylesheet href=/conf/custom.css><link rel=icon type=image/png sizes=32x32 href=/conf/images/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/conf/images/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/conf/images/apple-touch-icon.png><link href rel=alternate type=application/rss+xml title=Конспекты><script async src="https://www.googletagmanager.com/gtag/js?id=UA-107215405-3"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-107215405-3');</script></head><body><nav class=nav><div class=nav-container><a href=/conf/><h2 class=nav-title>Конспекты</h2></a><ul><li><a href=/conf/>Posts</a></li></ul></div></nav><main><div class=post><div class=single__header><div class=post-info>Вадим Мадисон, Avito</div><h1 class=post-title>Что мы знаем о микросервисах</h1><div class=post-line></div><div class=tag-block><span class=catalogue-tags><a href=/conf/tags/highload class=tags>Highload</a></span><span class=catalogue-tags><a href=/conf/tags/2018 class=tags>2018</a></span><span class=catalogue-tags><a href=/conf/tags/avito class=tags>Avito</a></span></div></div><h1 id=intro>Intro</h1><p>Авито: много сервисов и очень много связей между ними.</p><p>Вот основные проблемы от количества:</p><ul><li>Много разных репозиториев. Сложно менять код одновременно везде.</li><li>Много команд пишут код, не пересекаясь с другими. Знания инкапсулируются и плохо передаются между командами. Нет единой картины. Нет человека, который бы всё знал.</li><li>Данные фрагментарны.</li></ul><p>Проблемы с инфраструктурой: слишком много элементов:</p><ul><li>Логирование</li><li>Мониторинг</li><li>Сборка</li><li>Общение</li><li>Трекер задач</li><li>Документация</li><li>Аааааа</li></ul><p>Слои: service mesh, k8s, bare metal. Отдельно мониторинг и PaaS. Доклад будет как раз про него.</p><p>В платформе есть три основных части:</p><ul><li>Генераторы, управляются через CLI</li><li>Агрегатор (коллектор), управляется через дашборд</li><li>Хранилище (storage) с триггерами на определённые действия.</li></ul><h1 id=стандартный-конвейер-разработки-микросервиса>Стандартный конвейер разработки микросервиса</h1><h2 id=cli-push>CLI-push</h2><p>Создаём сервис из шаблона. Вместо первого <code>git push</code>.</p><p>Долго учили разработчиков правильно начинать работу, но это всё равно становится узким местом при внедрении микросервисов. Поэтому сделали утилиту в помощь разработчикам. Утилита делает вот что:</p><ol><li>Создаёт сервис из шаблона.</li><li>Разворачивает инфраструктуру для локальной разработки</li><li>Подключает БД одной командой без конфигов.</li></ol><p>Раньше деплой сервиса был сложный и составной.
Сделали проще: один файл <code>app.toml</code>.</p><p>Базовая валидация:</p><ul><li>Есть докерфайл</li><li>Есть <code>app.toml</code></li><li>Есть документация</li><li>Зависимости в порядке</li><li>УКазаны правила алертов для мониторинга. Владелец сервиса сам это настраивает.</li></ul><h2 id=документация>Документация</h2><p>Входит:</p><ul><li>Описание сервиса. В двух предложениях, что сервис делает.</li><li>Диаграмма архитектуры.</li><li>Runbook.</li><li>FAQ</li><li>Описание API endpoints</li><li>Labels — к какому продукту, функциональности и структурному подразделению относится сервис.</li><li>Владельцы. Обычно определяем автоматически, но на всякий случай надо.</li><li>Ревью?</li></ul><h2 id=подготовка-пайплайна>Подготовка пайплайна</h2><ul><li>Готовим репозитории</li><li>Делаем пайплайн в Teamcity</li><li>Выставляем права</li><li>Ищем владельцев — вычисляем по push&rsquo;ам в репозиторий.<ul><li>Одного недостаточно, ненадёжно. Ищем двух.</li><li>Считаем количество пушей и количество кода в пуше.</li></ul></li><li>Регистрируем сервис в Atlas</li><li>Проверяем миграции. Если они потенциально опасны, инфу в Атлас, а сервис в карантин.</li></ul><h2 id=дальше>Дальше</h2><ul><li>Собираем приложение в докер-образ</li><li>Генерируем хелмчарты для сервиса и его ресурсов</li><li>Создаем админские тикеты на открытие портов</li><li>Юнит-тесты, считаем покрытие кода. Результаты — в Атлас.</li><li>Считаем ограничения по памяти и процессору.</li></ul><p>Go + k8s + GOMAXPROCS — придётся оптимизировать производительность. Поможет библиотека <a href=https://github.com/uber-go/automaxprocs>automaxprocs</a>.</p><h2 id=проверка>Проверка</h2><p>Вот что проверяем:</p><ul><li>API endpoints</li><li>Их ответы соответствуют схеме</li><li>Формат логов</li><li>Выставление заголовков при запросах</li><li>Выставление заголовков при отправке сообщений в шину. Тут проверяется связность сервисов.</li></ul><h2 id=тесты>Тесты</h2><ul><li>Тестируем в закрытом контуре, например hoverfly.io.</li><li>Нагрузочное тестирование — важно.</li></ul><p>Нагрузочное тестирование показывает дельту производительности между версиями. Проверяем, что потребление соответствует заданным ограничениям.</p><ul><li>Слишком мало — OOM killer?</li><li>Слишком много — оптимизировать.</li></ul><h2 id=canary-tests>Canary tests</h2><p>Начинаем с очень малого процента — меньше 0,1%.</p><p>Держим от 5 минут до 2 часов.</p><p>Смотрим:</p><ul><li>Метрики, специфичные для языка. Например, воркеры php-fpm.</li><li>Ошибки в Sentry</li><li>Статусы ответов</li><li>Время ответов — точное и среднее</li><li>Latency</li><li>Исключения обработанные и необработанные</li><li>Продуктовые метрики, внезапно, тысячи их!</li></ul><h2 id=squeeze-testing>Squeeze testing</h2><p>Тестирование через выдавливание. Нагружаем реальными пользователями один инстанс, пока он не нагрузится на 100%, «в полку». Потом добавляем +1, снова смотрим полку, вычисляем дельту. Сравниваем эти данные с данными от искусственной нагрузки.</p><h2 id=прод>Прод</h2><p>Мониторим на продакшене.</p><p>Смотреть только на CPU — неэффективно, потому что соседи фонят. Поэтому смотрим на специфические для приложения метрики. Результаты — в Атлас.</p><p>Итого:</p><ul><li>CPU + RAM</li><li>количество запросов в очереди</li><li>время ответа</li><li>?</li></ul><h2 id=что-ещё>Что ещё</h2><ul><li>Миграции, если не осталось версий сервиса ниже Х</li><li>Обновления безопасности</li><li>Если сервис давно не обновлялся — пересобрать для проверки</li><li>Если метрики выходят из нормы — в карантин</li></ul><h2 id=дашборд>Дашборд</h2><p>Смотрим на всё сверху в агрегированном виде и делаем выводы.</p></div><div class=pagination><a href=/conf/moscowpython/19/accelerate-python/ class="right arrow">&#8594;</a>
<a href=# class=top>Top</a></div></main><footer><span>&copy; <time datetime="2021-09-16 14:59:00.292777615 &#43;0000 UTC m=&#43;0.158809268">2021</time> . Made with <a href=https://gohugo.io>Hugo</a> using the <a href=https://github.com/EmielH/tale-hugo/>Tale</a> theme.</span></footer></body></html>