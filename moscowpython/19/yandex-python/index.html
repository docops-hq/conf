<!DOCTYPE html>
<html lang="en-us">
    <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>
				Как развивался Python в Яндексе &middot; Конспекты
		</title>

		
  		<link rel="stylesheet" href="/conf/css/style.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">
		<link rel="stylesheet" href="/conf/custom.css">
		
		<link rel="icon" type="image/png" sizes="32x32" href="/conf/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/conf/images/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/conf/images/apple-touch-icon.png">

		
		<link href="" rel="alternate" type="application/rss+xml" title="Конспекты" />
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-107215405-3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-107215405-3');
  </script>
	</head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/conf/">
					<h2 class="nav-title">Конспекты</h2>
				</a>
				<ul>
    <li><a href="/conf/">Posts</a></li>
</ul>

			</div>
		</nav>

        

<main>
	<div class="post">
		<div class="single__header">
			<div class="post-info">
        Александр Кóшелев, Яндекс
</div>

			<h1 class="post-title">Как развивался Python в Яндексе</h1>
<div class="post-line"></div>
<div class="tag-block"><span class="catalogue-tags"><a href='/conf/tags/moscow-python-conf' class="tags" >Moscow Python Conf</a></span><span class="catalogue-tags"><a href='/conf/tags/2019' class="tags" >2019</a></span><span class="catalogue-tags"><a href='/conf/tags/%D1%8F%D0%BD%D0%B4%D0%B5%D0%BA%D1%81' class="tags" >Яндекс</a></span><span class="catalogue-tags"><a href='/conf/tags/python' class="tags" >Python</a></span></div>

		</div>

		

		

<p>Александр в Яндексе с 2008 года, писал Афишу и другие сервисы, потом ушёл во внутренние сервисы.
Сейчас руководит отрядом из 30 питонистов.</p>

<p>Важно: Яндекс — большая компания, потому сложно сказать про всех сразу.
Доклад Александра — в первую очередь про его опыт в Яндексе, его интерпретация событий.</p>

<h1 id="введение">Введение</h1>

<p>Эволюцию Python в Яндексе можно разделить на эпохи.
Их границы — это переход к новым инструментам и подходам.</p>

<ol>
<li>Железо</li>
<li>Железо + venv</li>
<li>Контейнеры</li>
<li>Бинарная сборка</li>
</ol>

<p>Вот что важно рассказать про каждую эпоху:</p>

<ul>
<li>Инфраструктура</li>
<li>Фреймворки</li>
<li>Работа с зависимостями</li>
<li>Общий код</li>
<li>Среда разработки</li>
<li>Плюсы и минусы</li>
</ul>

<h1 id="эпоха-1-железо-2008-2011">Эпоха 1: железо, 2008-2011</h1>

<p>«Куда все идут» — часть Афиши и первый сервис на Django.
Следом шла сама Афиша, Погода, Телепрограмма.</p>

<h2 id="инфраструктура">Инфраструктура</h2>

<p>Приложения работают просто на железных машинах, объединенных в большие общие кластера.
ОС – Debian/Ubuntu.
Приложения запускаются <code>initd</code>, общаются с веб-сервером через FastCGI (flup).</p>

<h2 id="фреймворки">Фреймворки</h2>

<p>Django, CherryPy, Web.py</p>

<h2 id="зависимости">Зависимости</h2>

<p>Работа с зависимостями была устроена так:</p>

<ul>
<li>Собираем deb-пакет с кодом проекта;</li>
<li>Для каждой зависимости тоже свой пакет;</li>
<li>Дополняем своими пакетами системный репозиторий.</li>
</ul>

<h2 id="общий-код">Общий код</h2>

<p>В компании появляется много собственного кода, который используют все команды.
Такой внутренний опенсорс.
Все библиотеки — в отдельных репозиториях, каждая заворачивается в deb-пакет.</p>

<p>Типичный сервер выглядит так:</p>

<p><img src="../../../images/static/yandex-python-01.png" alt="yandex-python-01" /></p>

<p>Следствие: на одном сервере все приложения должны иметь одинаковые зависимости.
    Чем больше приложений на сервере, тем сложнее всё это поддерживать.</p>

<h2 id="среда-разработки">Среда разработки</h2>

<ul>
<li>Для всех — удаленно на дев-сервере.</li>
<li>Если сотрудник работает на линуксе, то локально на своей машине</li>
<li>Если работает на Windows, то в виртуальной машине.</li>
</ul>

<h2 id="плюсы-и-минусы">Плюсы и минусы</h2>

<ul>
<li>:x: Приложениям тесно на общем кластере.</li>
<li>:x: У всех приложений должны быть одинаковые зависимости.</li>
<li>:x: Приложения с общими зависимостями нужно релизить ОДНОВРЕМЕННО.
Разумеется, это ведёт к многократным откатам на прошлый релиз и прочему веселью.</li>
<li>:x: Сильная зависимость от инфраструктуры Debian.</li>
</ul>

<h2 id="почему-вообще-стали-использовать-django">Почему вообще стали использовать Django</h2>

<p>Автор уже рассказывал об этом на одной конференции 11 лет назад.
С тех пор всё ещё любит Django, и вот почему:</p>

<ul>
<li>низкий порог входа</li>
<li>большая экосистема</li>
<li>много специалистов на рынке труда</li>
<li>есть всё необходимое для работы</li>
<li>достаточная гибкость</li>
</ul>

<h1 id="эпоха-2-железо-venv-2012-2015">Эпоха 2: железо + venv, 2012-2015</h1>

<h2 id="инфраструктура-1">Инфраструктура</h2>

<p>В инфраструктуре появились «виртуалки»: OpenVZ, LXC и другие.
Но их только пробовали, технология была слабо развита, всё равно все жили в общих кластерах.</p>

<p>Запуск приложений теперь через upstart или systems.
Отказались от FastCGI в пользу WSGI (uwsgi) или HTTP (unicorn).
Перешли на nginx в качестве основного вебсервера.</p>

<h2 id="фреймворки-1">Фреймворки</h2>

<p>Tornado, Flask, Celery для распределённых задач.</p>

<h2 id="зависимости-1">Зависимости</h2>

<p>Работа с зависимостями:  начали собирать виртуальное окружение.
Ура, можно не ставить библиотеки в систему, а держать сколько нужно виртуальных окружений.
Теперь пакуем venv вместе с кодом проекта в deb-пакет.</p>

<p>Теперь на сервере есть раздельные питоновые зависимости и общие системные:</p>

<p><img src="../../../images/static/yandex-python-02.png" alt="yandex-python-02" /></p>

<h2 id="общий-код-1">Общий код</h2>

<p>К этому моменту частично отказались от инфраструктуры Debian,
да и deb-пакеты с зависимостями не подходят для venv.
Поэтому подняли свой PyPI на базе <a href="https://github.com/mvantellingen/localshop">Localshop</a>.
Сейчас в нём более тысячи внутренних пакетов.</p>

<h2 id="среда-разработки-1">Среда разработки</h2>

<p>Поменялась к лучшему.
Работаем в виртуальном окружении на любой ОС: Windows, Linux, macOS</p>

<h2 id="плюсы-и-минусы-1">Плюсы и минусы</h2>

<ul>
<li>:heavy_check_mark: с venv стало проще жить на кластерах-общежитиях.</li>
<li>:x: всё ещё есть общие системные зависимости</li>
<li>:x: не все команды переехали на venv, некоторым проектам ещё нужны конкретные системные библиотеки Python.</li>
</ul>

<h2 id="почему-выбрали-tornado">Почему выбрали Tornado</h2>

<p>Потому что это (был) современный асинхронный фреймворк.
Альтернативы не понравились:</p>

<ul>
<li>gevent — внутри хак</li>
<li>twisted — морально устарел</li>
<li>asyncio — только в Python3, а на него ещё переехать надо.</li>
</ul>

<h2 id="почему-выбрали-celery">Почему выбрали Celery</h2>

<p>Потому что это хороший фреймворк для очередей задач.
Используют до сих пор (2019 год).
Поддерживает множество брокеров очередей: SQS, RabbitMQ, MongoDB, Redis.
Наконец, просто чаще работает, чем не работает.</p>

<h1 id="эпоха-3-контейнеры-2016-2018">Эпоха 3: контейнеры, 2016-2018</h1>

<p>Инфраструктура — внутреннее docker-совместимое облако.
То есть там не docker, но стандартные образы можно туда пушить.
Запуск приложений с помощью supervisord или uwsgi.
Оказалось, что uwsgi хорошо справляется с задачей запуска процессов.
И его же используют для HTTP.</p>

<p><img src="../../../images/static/yandex-python-03.png" alt="yandex-python-03" /></p>

<h2 id="фреймворки-2">Фреймворки</h2>

<ul>
<li>появился Falcon. Например, Алису переписали с Django на Falcon.</li>
<li>asyncio (наконец переехали на Python3)</li>
</ul>

<h2 id="работа-с-зависимостями">Работа с зависимостями</h2>

<ul>
<li>Всё внутри докер-образа. При сборке просто устанавливаем всё с помощью pip.</li>
<li>Все системные зависимости тоже изолированы.</li>
</ul>

<p>Но теперь стало сложнее внедрять общие подходы к сборке и обновлять общие зависимости.</p>

<h2 id="среда-разработки-2">Среда разработки</h2>

<ul>
<li>Локально на любой ОС</li>
<li>Разработка тоже через Docker</li>
<li>Docker-compose помогает поднять сервисы на локальной машине и потестить,
даже несмотря на то, что целевое облако — не докер.
<br /></li>
</ul>

<h2 id="плюсы-и-минусы-2">Плюсы и минусы</h2>

<ul>
<li>:heavy_check_mark: полная изоляция</li>
<li>:heavy_check_mark: удобный toolchain</li>
<li>:heavy_check_mark: поддержка IDE</li>
<li>:x: на не-Linux машинах с докером всё непросто, есть ограничения.</li>
</ul>

<h2 id="почему-docker">Почему Docker</h2>

<ul>
<li>поддерживает большинство платформ</li>
<li>эффективно</li>
<li>хорошая экосистема</li>
<li>де-факто стандарт, все умеют с ним работать</li>
</ul>

<h1 id="эпоха-4-бинарная-сборка-2019">Эпоха 4: бинарная сборка, 2019…</h1>

<p>Раньше весь Яндекс был на Debian-инфраструктуре.
А теперь весь Яндекс идёт к большому монорепозиторию.
Вокруг него есть механизм сборки, распределённого тестирования и куча других инструментов.
В первую очередь это для кода на C++ и Go, но Python тоже подтягивается.</p>

<p>Мы собираем бинарь и оно просто работает на любой совместимой архитектуре. Чудо!</p>

<p><img src="../../../images/static/yandex-python-04.png" alt="yandex-python-04" /></p>

<h2 id="плюсы-и-минусы-3">Плюсы и минусы</h2>

<ul>
<li>:heavy_check_mark: Единый принцип сборки периложений во всей компании.</li>
<li>:heavy_check_mark: Единообразная сборка с зависимостями.</li>
<li>:heavy_check_mark: Если есть чекаут репозитория локально, то его достаточно, чтобы собрать проект.</li>
<li>:heavy_check_mark: Удобство дистрибуции.</li>
<li>:x: Порог входа: новому сотруднику нужно время, чтобы это освоить.</li>
</ul>

<h1 id="выводы">Выводы</h1>

<ul>
<li>Эволюция неизбежна!</li>
<li>Не бойтесь изменений</li>
<li>Идите в ногу с внешними трендами</li>
<li>Не отказывайтесь от проверенных решений</li>
<li>Развивайте внутреннюю python-экосистему в компании</li>
</ul>

<h1 id="вопросы">Вопросы</h1>

<p>Q: Не было ли проблем с пакетами, которые работают глубоко в драйверах?<br />
A: Иногда бывает, когда пакет завязан на системные зависимости и может, например, не работать в venv.
    Тогда просто собираем deb-пакеты.</p>

<p>Q: Что насчёт CI?<br />
A: Раньше использовали Teamcity, сейчас внутреннюю разработку.
    Вообще в компании много разных CI используют.</p>

<p>Q: Были ли проблемы с ресурсами, например с модельками для машинного обучения? Как храните их?<br />
A: Храним по-разному.</p>

<p>Q: Есть ли на одних и тех же серверах проекты из разных эпох?<br />
A: В облаке только третья эпоха, а на кластерах бывают разные.
    Пробовали выселять проекты из первой эпохи на отдельные серверы.</p>


		
	</div>

	<div class="pagination">
		<a href="/conf/highload/19/siberia/docs/" class="left arrow">&#8592;</a>
		<a href="/conf/whalerider/19/investor/" class="right arrow">&#8594;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			<span>
			&copy; <time datetime="2020-02-24 20:54:54.110612 &#43;0700 &#43;07 m=&#43;0.249051224">2020</time> . Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
